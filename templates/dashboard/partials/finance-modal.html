{% load turkish_format %}
{% comment %}
Reusable modal component for displaying finance transactions in Gelir/Gider Toplamları page.
Expecting variables:
- modal_id: unique id for modal
- title: modal title text
- entries: list of dictionaries with keys (tarih, hareket, aciklama, amount)
- total: numeric total for footer display
- color_class: optional bootstrap color keyword used in header background
{% endcomment %}
<div class="modal fade" id="{{ modal_id }}" tabindex="-1" aria-labelledby="{{ modal_id }}Label" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-{{ color_class|default:'primary' }}">
                <h5 class="modal-title text-white" id="{{ modal_id }}Label">{{ title }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                {% if selected_range %}
                <div class="alert alert-light border d-flex align-items-center gap-2 py-2 px-3 mb-3">
                    <i class="bi bi-calendar4-range text-primary"></i>
                    <div>
                        <div class="text-muted small">Gösterilen tarih aralığı</div>
                        <strong>{{ selected_range }}</strong>
                    </div>
                </div>
                {% endif %}
                
                <!-- Kategori Filtresi -->
                <div class="mb-3">
                    <label class="form-label small text-muted">Kategori Filtrele</label>
                    <select class="form-select form-select-sm kategori-filter" data-modal-id="{{ modal_id }}">
                        <option value="">Tüm Kategoriler</option>
                    </select>
                </div>
                
                {% if entries %}
                <div class="table-responsive">
                    <table class="table align-middle mb-0">
                        <thead>
                            <tr>
                                <th style="width: 10%;">Tarih</th>
                                <th style="width: 12%;">Kasa Adı</th>
                                <th style="width: 10%;">Hareket</th>
                                <th style="width: 16%;">Ana Kategori</th>
                                <th style="width: 16%;">Alt Kategori</th>
                                <th>Açıklama</th>
                                <th class="text-end" style="width: 12%;">Tutar</th>
                                {% if modal_id == 'modalKrediKarti' or modal_id == 'modalCari' or modal_id == 'modalSanalPos' or modal_id == 'modalBankaHavale' %}
                                <th class="text-end" style="width: 12%;">Komisyon (%20)</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in entries %}
                            <tr>
                                <td>{{ entry.tarih }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ entry.kasa_adi }}</span>
                                </td>
                                <td>
                                    <span class="badge {% if entry.amount >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ entry.hareket }}
                                    </span>
                                </td>
                                <td>
                                    {% if entry.ana_kategori %}
                                        <span class="badge bg-primary">{{ entry.ana_kategori }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if entry.alt_kategori %}
                                        <span class="badge bg-info">{{ entry.alt_kategori }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.aciklama }}</td>
                                <td class="text-end fw-semibold {% if entry.amount >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ entry.amount|turkish_lira }}
                                </td>
                                {% if modal_id == 'modalKrediKarti' or modal_id == 'modalCari' or modal_id == 'modalSanalPos' or modal_id == 'modalBankaHavale' %}
                                <td class="text-end fw-semibold text-danger">
                                    {% if entry.komisyon %}
                                        -{{ entry.komisyon|turkish_lira }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">Bu kategori için henüz işlem bulunmuyor.</p>
                {% endif %}
            </div>
            <div class="modal-footer justify-content-between">
                <div class="d-flex flex-column gap-1">
                    <span class="fw-semibold">
                        Toplam:
                        <span class="{% if total >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ total|turkish_lira }}
                        </span>
                    </span>
                    {% if modal_id == 'modalKrediKarti' or modal_id == 'modalCari' or modal_id == 'modalSanalPos' or modal_id == 'modalBankaHavale' %}
                    {% if komisyon_toplam %}
                    <span class="fw-semibold small">
                        Komisyon Toplamı (%20):
                        <span class="text-danger">
                            -{{ komisyon_toplam|turkish_lira }}
                        </span>
                    </span>
                    {% endif %}
                    {% endif %}
                </div>
                <div class="d-flex flex-column align-items-end gap-1">
                    <span class="fw-semibold small">
                        Filtrelenen Toplam:
                        <span class="{% if total >= 0 %}text-success{% else %}text-danger{% endif %}"
                              data-filtered-total
                              data-initial-total="{{ total|turkish_lira }}">
                            {{ total|turkish_lira }}
                        </span>
                    </span>
                    <button type="button" class="btn btn-outline-secondary btn-sm mt-1" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('{{ modal_id }}');
    if (!modal) return;
    
    const filterSelect = modal.querySelector('.kategori-filter');
    const tableBody = modal.querySelector('tbody');
    const filteredTotalEl = modal.querySelector('[data-filtered-total]');
    
    if (!filterSelect || !tableBody || !filteredTotalEl) return;

    function parseTurkishMoney(text) {
        if (!text) return 0;
        let value = text.toString().trim();
        let negative = false;

        if (value.startsWith('-')) {
            negative = true;
            value = value.slice(1);
        }

        // TL ve ₺ ifadelerini kaldır
        value = value.replace(/TL/gi, '').replace(/₺/g, '').trim();
        // Binlik ayraçları kaldır, ondalık için virgülü noktaya çevir
        value = value.replace(/\./g, '').replace(',', '.');

        const num = parseFloat(value || '0');
        return negative ? -num : num;
    }

    function formatTurkishMoney(value) {
        const negative = value < 0;
        let intPart = Math.round(Math.abs(value)).toString();
        intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        return (negative ? '-' : '') + intPart + ' TL';
    }

    function updateFilteredTotal() {
        const rows = tableBody.querySelectorAll('tr');
        let sum = 0;

        rows.forEach(row => {
            if (row.style.display === 'none') return;
            // Tutar sütunu her zaman 6. indexte (0-based)
            const amountCell = row.cells[6];
            if (!amountCell) return;
            const amountText = amountCell.textContent || '';
            sum += parseTurkishMoney(amountText);
        });

        filteredTotalEl.textContent = formatTurkishMoney(sum);
        filteredTotalEl.classList.toggle('text-success', sum >= 0);
        filteredTotalEl.classList.toggle('text-danger', sum < 0);
    }
    
    // Modal açıldığında kategorileri topla
    modal.addEventListener('shown.bs.modal', function() {
        const rows = tableBody.querySelectorAll('tr');
        const categories = new Set();
        
        rows.forEach(row => {
            const categoryCell = row.cells[3]; // Ana Kategori sütunu
            if (categoryCell) {
                const badge = categoryCell.querySelector('.badge');
                if (badge) {
                    categories.add(badge.textContent.trim());
                }
            }
        });
        
        // Dropdown'ı doldur
        filterSelect.innerHTML = '<option value="">Tüm Kategoriler</option>';
        Array.from(categories).sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            filterSelect.appendChild(option);
        });

        // Modal açıldığında mevcut satırlara göre filtre toplamını hesapla
        updateFilteredTotal();
    });
    
    // Filtreleme
    filterSelect.addEventListener('change', function() {
        const selectedCategory = this.value;
        const rows = tableBody.querySelectorAll('tr');
        
        rows.forEach(row => {
            if (!selectedCategory) {
                row.style.display = '';
            } else {
                const categoryCell = row.cells[3];
                const badge = categoryCell ? categoryCell.querySelector('.badge') : null;
                const categoryText = badge ? badge.textContent.trim() : '';
                
                if (categoryText === selectedCategory) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Filtre değiştiğinde toplamı güncelle
        updateFilteredTotal();
    });
});
</script>
