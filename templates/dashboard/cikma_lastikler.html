{% extends 'base.html' %}
{% load static %}
{% load turkish_format %}

{% block title %}√áƒ±kma Lastikler - Mestakip{% endblock %}

{% block extra_css %}
<style>
/* Mobil optimizasyonlarƒ± */
@media (max-width: 768px) {
    /* Header d√ºzenlemeleri */
    .mobile-header {
        flex-direction: column;
        gap: 10px;
    }
    
    .mobile-header .btn-group {
        width: 100%;
        display: flex;
        gap: 5px;
    }
    
    .mobile-header .btn {
        flex: 1;
        font-size: 0.8rem;
        padding: 8px 4px;
    }
    
    /* Filtreleme kartƒ± mobil optimizasyonu */
    .filter-card {
        margin-bottom: 15px;
    }
    
    .filter-card .card-body {
        padding: 15px;
    }
    
    .filter-row {
        gap: 10px !important;
    }
    
    .filter-col {
        margin-bottom: 10px;
    }
    
    .form-label {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .form-control, .form-select {
        font-size: 0.9rem;
        padding: 8px 10px;
    }
    
    /* Mobil kart g√∂r√ºn√ºm√º */
    .mobile-card-view {
        display: block;
    }
    
    .desktop-table-view {
        display: none;
    }
    
    .lastik-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 15px;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .lastik-card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        padding: 12px 15px;
        border-bottom: 1px solid #dee2e6;
        border-radius: 8px 8px 0 0;
    }
    
    .lastik-card-body {
        padding: 15px;
    }
    
    .lastik-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .lastik-info-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    .info-label {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
        min-width: 80px;
    }
    
    .info-value {
        font-size: 0.9rem;
        font-weight: 600;
        text-align: right;
        flex: 1;
        color: #212529;
    }
    
    .ebat-code {
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        font-weight: bold;
    }
    
    .mevsim-icon {
        width: 20px;
        height: 20px;
        object-fit: contain;
        border-radius: 3px;
        margin-right: 5px;
    }
    
    .mobile-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #f1f3f4;
    }
    
    .mobile-actions .btn {
        flex: 1;
        font-size: 0.8rem;
        padding: 8px 4px;
    }
    
    /* Pagination mobil */
    .pagination {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .pagination .page-item .page-link {
        padding: 6px 10px;
        font-size: 0.85rem;
    }
    
    /* Modal optimizasyonlarƒ± */
    .modal-dialog {
        margin: 10px;
        max-width: calc(100% - 20px);
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .modal-footer {
        padding: 10px 15px;
    }
    
    /* Floating Action Button */
    .fab {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #28a745;
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .fab:hover {
        background: #218838;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(40, 167, 69, 0.5);
    }
    
    /* Quick filter buttons */
    .quick-filters {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        overflow-x: auto;
        padding: 5px 0;
    }
    
    .quick-filter-btn {
        white-space: nowrap;
        font-size: 0.8rem;
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid #dee2e6;
        background: white;
        color: #495057;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .quick-filter-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .quick-filter-btn:hover {
        background: #f8f9fa;
        text-decoration: none;
        color: #495057;
    }
    
    .quick-filter-btn.active:hover {
        background: #0056b3;
        color: white;
    }
    
    /* Compact mobile filter */
    .compact-mobile-filter {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .compact-mobile-filter .form-control-sm {
        font-size: 0.8rem;
        padding: 6px 8px;
    }
    
    .compact-mobile-filter .btn-sm {
        padding: 6px 10px;
        font-size: 0.8rem;
    }
}

/* Desktop g√∂r√ºn√ºm√º */
@media (min-width: 769px) {
    .mobile-card-view {
        display: none;
    }
    
    .desktop-table-view {
        display: block;
    }
    
    .fab {
        display: none;
    }
}

/* Genel iyile≈ütirmeler */
.badge {
    font-size: 0.75rem;
}

.text-truncate-mobile {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-3 mobile-header">
    <div>
        <h1 class="h4 mb-1">√áƒ±kma Lastikler</h1>
        <p class="text-muted mb-0 small">M√º≈üterilerden √ßƒ±kan lastiklerin takibi</p>
    </div>
    <div class="d-none d-md-flex gap-2">
        {% if not is_misafir %}
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#yeniKayitModal">
            <i class="bi bi-plus-lg me-1"></i>
            Yeni Kayƒ±t
        </button>
        {% endif %}
        <a href="{% url 'dashboard:satilan_cikma_lastikler' %}" class="btn btn-warning">
            <i class="bi bi-check-circle me-1"></i>
            Satƒ±lanlarƒ± G√∂r√ºnt√ºle
        </a>
    </div>
    <div class="d-md-none btn-group w-100">
        {% if not is_misafir %}
        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#yeniKayitModal">
            <i class="bi bi-plus-lg"></i>
            Yeni
        </button>
        {% endif %}
        <a href="{% url 'dashboard:satilan_cikma_lastikler' %}" class="btn btn-warning btn-sm">
            <i class="bi bi-check-circle"></i>
            Satƒ±lan
        </a>
    </div>
</div>

<!-- Quick Filters (Mobile) -->
<div class="quick-filters d-md-none">
    <a href="?durum=" class="quick-filter-btn {% if not filters.durum %}active{% endif %}">T√ºm√º</a>
    <a href="?durum=depolandi" class="quick-filter-btn {% if filters.durum == 'depolandi' %}active{% endif %}">Depoda</a>
    <a href="?durum=cikti" class="quick-filter-btn {% if filters.durum == 'cikti' %}active{% endif %}">√áƒ±ktƒ±</a>
    <a href="?mevsim=yaz" class="quick-filter-btn {% if filters.mevsim == 'yaz' %}active{% endif %}">‚òÄÔ∏è Yaz</a>
    <a href="?mevsim=kis" class="quick-filter-btn {% if filters.mevsim == 'kis' %}active{% endif %}">‚ùÑÔ∏è Kƒ±≈ü</a>
    <a href="?mevsim=dort-mevsim" class="quick-filter-btn {% if filters.mevsim == 'dort-mevsim' %}active{% endif %}">üîÑ 4 Mevsim</a>
</div>

<!-- Compact Mobile Filter -->
<div class="compact-mobile-filter d-md-none mb-3">
    <form method="get" class="d-flex gap-2 flex-wrap">
        <input type="text" class="form-control form-control-sm" name="marka" value="{{ filters.marka }}" placeholder="Marka ara..." style="flex: 2; min-width: 120px;">
        <input type="text" class="form-control form-control-sm" name="ebat" value="{{ filters.ebat }}" placeholder="Ebat..." style="flex: 1; min-width: 80px;">
        {% if not is_misafir %}
        <input type="text" class="form-control form-control-sm" name="depo_konumu" value="{{ filters.depo_konumu }}" placeholder="Depo..." style="flex: 1; min-width: 80px;">
        {% endif %}
        <button type="submit" class="btn btn-primary btn-sm">
            <i class="bi bi-search"></i>
        </button>
        {% if filters.marka or filters.ebat or filters.depo_konumu %}
        <a href="{% url 'dashboard:cikma_lastikler' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-x"></i>
        </a>
        {% endif %}
    </form>
</div>

<!-- Filtering Section -->
<div class="card mb-3 filter-card d-none d-md-block">
    <div class="card-header">
        <h6 class="card-title mb-0">Filtreleme</h6>
    </div>
    <div class="card-body">
        <form method="get">
            <div class="row g-2 filter-row">
                <div class="col-md-2 col-6 filter-col">
                    <label for="marka" class="form-label">MARKA</label>
                    <input type="text" class="form-control" id="marka" name="marka" value="{{ filters.marka }}" placeholder="Marka adƒ±...">
                </div>
                <div class="col-md-2 col-6 filter-col">
                    <label for="ebat" class="form-label">EBAT</label>
                    <input type="text" class="form-control" id="ebat" name="ebat" value="{{ filters.ebat }}" placeholder="205/55R16...">
                </div>
                {% if not is_misafir %}
                <div class="col-md-2 col-6 filter-col">
                    <label for="depo_konumu" class="form-label">AMBAR (DEPO)</label>
                    <input type="text" class="form-control" id="depo_konumu" name="depo_konumu" value="{{ filters.depo_konumu }}" placeholder="Raf A-1...">
                </div>
                {% endif %}
                <div class="col-md-2 col-6 filter-col">
                    <label for="durum" class="form-label">DURUM</label>
                    <select class="form-select" id="durum" name="durum">
                        <option value="">T√ºm√º</option>
                        {% for value, label in durum_choices %}
                        <option value="{{ value }}" {% if filters.durum == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 col-6 filter-col">
                    <label for="mevsim" class="form-label">MEVSƒ∞M</label>
                    <select class="form-select" id="mevsim" name="mevsim">
                        <option value="">T√ºm√º</option>
                        {% for value, label in mevsim_choices %}
                        <option value="{{ value }}" {% if filters.mevsim == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 col-12 filter-col d-flex align-items-end">
                    <div class="d-flex gap-2 w-100">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="bi bi-funnel me-1"></i>
                            Filtrele
                        </button>
                        <a href="{% url 'dashboard:cikma_lastikler' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i>
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Main Content Section -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">√áƒ±kma Lastik Listesi</h6>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-warning btn-sm d-none d-md-inline-block">
                <i class="bi bi-file-earmark-excel me-1"></i>
                Excel'e Aktar
            </button>
        </div>
    </div>
    
    <!-- Desktop Table View -->
    <div class="card-body p-0 desktop-table-view">
        <div class="table-responsive" style="overflow-x: auto;">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        {% if not is_misafir %}
                        <th style="min-width: 80px;">KALƒ∞TE</th>
                        {% endif %}
                        <th style="min-width: 100px;">EBAT</th>
                        <th style="min-width: 150px;">MARKA/MODEL</th>
                        <th style="min-width: 60px;" class="text-center">MEVSƒ∞M</th>
                        <th style="min-width: 60px;">ADET</th>
                        {% if not is_misafir %}
                        <th style="min-width: 120px;">AMBAR (DEPO)</th>
                        {% endif %}
                        <th style="min-width: 150px;">A√áIKLAMA</th>
                        <th style="min-width: 100px;">Gƒ∞Rƒ∞≈û TARƒ∞Hƒ∞</th>
                        {% if not is_misafir %}
                        <th style="min-width: 120px;">ƒ∞≈ûLEMLER</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for lastik in cikma_lastikler %}
                    <tr>
                        {% if not is_misafir %}
                        <td>
                            {% if lastik.kalite_notu %}
                                <span class="badge bg-{{ lastik.get_kalite_display_color }}">{{ lastik.get_kalite_display }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td><code style="font-size: 1.1em; font-weight: 600;">{{ lastik.ebat }}</code></td>
                        <td>
                            <strong>{{ lastik.marka }}</strong>
                            {% if lastik.model %}
                                <br><small class="text-muted">{{ lastik.model }}</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if lastik.mevsim == 'yaz' %}
                                <img src="{% static 'images/yaz.png' %}" alt="Yaz" title="Yaz Lastiƒüi" 
                                     style="width: 24px; height: 24px; object-fit: contain; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                            {% elif lastik.mevsim == 'kis' %}
                                <img src="{% static 'images/kis.png' %}" alt="Kƒ±≈ü" title="Kƒ±≈ü Lastiƒüi" 
                                     style="width: 24px; height: 24px; object-fit: contain; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                            {% elif lastik.mevsim == 'dort-mevsim' %}
                                <img src="{% static 'images/d√∂rtmevsim.png' %}" alt="4 Mevsim" title="4 Mevsim Lastiƒüi" 
                                     style="width: 24px; height: 24px; object-fit: contain; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ lastik.adet }}</strong></td>
                        {% if not is_misafir %}
                        <td>
                            {% if lastik.depo_konumu %}
                                <span class="badge bg-info">{{ lastik.depo_konumu }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        <td>
                            {% if lastik.aciklama %}
                                <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ lastik.aciklama }}">
                                    {{ lastik.aciklama }}
                                </span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>{{ lastik.olusturma_tarihi|date:"d.m.Y" }}</td>
                        {% if not is_misafir %}
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-success btn-sm" title="Sat" 
                                        data-bs-toggle="modal" data-bs-target="#satisModal{{ lastik.id }}">
                                    <i class="bi bi-currency-dollar"></i> Sat
                                </button>
                                <button type="button" class="btn btn-warning btn-sm" title="D√ºzenle"
                                        data-edit-url="{% url 'dashboard:cikma_lastik_duzenle' lastik.id %}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" title="Sil" 
                                        data-delete-url="{% url 'dashboard:cikma_lastik_sil' lastik.id %}"
                                        data-confirm-message="Bu kaydƒ± silmek istediƒüinizden emin misiniz?">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="12" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                            Hen√ºz √ßƒ±kma lastik kaydƒ± bulunmuyor.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Mobile Card View -->
    <div class="mobile-card-view">
        <div class="p-3">
            {% for lastik in cikma_lastikler %}
            <div class="lastik-card">
                <div class="lastik-card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="text-primary">{{ lastik.marka }}</strong>
                            {% if lastik.model %}
                                <small class="text-muted d-block">{{ lastik.model }}</small>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <span class="ebat-code">{{ lastik.ebat }}</span>
                        </div>
                    </div>
                </div>
                <div class="lastik-card-body">
                    <div class="lastik-info-row">
                        <span class="info-label">Mevsim:</span>
                        <span class="info-value">
                            {% if lastik.mevsim == 'yaz' %}
                                <img src="{% static 'images/yaz.png' %}" alt="Yaz" class="mevsim-icon">Yaz
                            {% elif lastik.mevsim == 'kis' %}
                                <img src="{% static 'images/kis.png' %}" alt="Kƒ±≈ü" class="mevsim-icon">Kƒ±≈ü
                            {% elif lastik.mevsim == 'dort-mevsim' %}
                                <img src="{% static 'images/d√∂rtmevsim.png' %}" alt="4 Mevsim" class="mevsim-icon">4 Mevsim
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="lastik-info-row">
                        <span class="info-label">Adet:</span>
                        <span class="info-value">
                            <strong class="text-success">{{ lastik.adet }} adet</strong>
                        </span>
                    </div>
                    {% if not is_misafir %}
                    <div class="lastik-info-row">
                        <span class="info-label">Kalite:</span>
                        <span class="info-value">
                            {% if lastik.kalite_notu %}
                                <span class="badge bg-{{ lastik.get_kalite_display_color }}">{{ lastik.get_kalite_display }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </span>
                    </div>
                    {% endif %}
                    {% if lastik.depo_konumu and not is_misafir %}
                    <div class="lastik-info-row">
                        <span class="info-label">Depo:</span>
                        <span class="info-value">
                            <span class="badge bg-info">{{ lastik.depo_konumu }}</span>
                        </span>
                    </div>
                    {% endif %}
                    <div class="lastik-info-row">
                        <span class="info-label">A√ßƒ±klama:</span>
                        <span class="info-value text-truncate-mobile" title="{{ lastik.aciklama|default:'' }}">
                            {{ lastik.aciklama|default:"-" }}
                        </span>
                    </div>
                    
                    {% if not is_misafir %}
                    <div class="mobile-actions">
                        <button type="button" class="btn btn-success btn-sm" 
                                data-bs-toggle="modal" data-bs-target="#satisModal{{ lastik.id }}">
                            <i class="bi bi-currency-dollar"></i> Sat
                        </button>
                        <button type="button" class="btn btn-warning btn-sm"
                                data-edit-url="{% url 'dashboard:cikma_lastik_duzenle' lastik.id %}">
                            <i class="bi bi-pencil"></i> D√ºzenle
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" 
                                data-delete-url="{% url 'dashboard:cikma_lastik_sil' lastik.id %}"
                                data-confirm-message="Bu kaydƒ± silmek istediƒüinizden emin misiniz?">
                            <i class="bi bi-trash"></i> Sil
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox" style="font-size: 3rem; display: block; margin-bottom: 1rem;"></i>
                <h6>Hen√ºz √ßƒ±kma lastik kaydƒ± bulunmuyor.</h6>
                <p class="small">Yeni kayƒ±t eklemek i√ßin + butonuna tƒ±klayƒ±n.</p>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Pagination -->
    <div class="card-footer">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="text-muted small">
                {% if cikma_lastikler.has_other_pages %}
                    Sayfa {{ cikma_lastikler.number }} / {{ cikma_lastikler.paginator.num_pages }} - 
                    {{ cikma_lastikler.start_index }}-{{ cikma_lastikler.end_index }} arasƒ± kayƒ±tlar (Toplam: {{ cikma_lastikler.paginator.count }})
                {% else %}
                    Toplam <strong>{{ cikma_lastikler.paginator.count }}</strong> kayƒ±t g√∂steriliyor
                {% endif %}
            </div>
            {% if cikma_lastikler.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-2 mt-md-0">
                <ul class="pagination pagination-sm mb-0">
                    {% if cikma_lastikler.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ cikma_lastikler.previous_page_number }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}">√ñnceki</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">√ñnceki</a>
                        </li>
                    {% endif %}
                    
                    {% for num in cikma_lastikler.paginator.page_range %}
                        {% if cikma_lastikler.number == num %}
                            <li class="page-item active">
                                <a class="page-link" href="#">{{ num }}</a>
                            </li>
                        {% else %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if cikma_lastikler.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ cikma_lastikler.next_page_number }}{% if filter_query_string %}&{{ filter_query_string }}{% endif %}">Sonraki</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">Sonraki</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Floating Action Button (Mobile) -->
{% if not is_misafir %}
<button type="button" class="fab d-md-none" data-bs-toggle="modal" data-bs-target="#yeniKayitModal">
    <i class="bi bi-plus-lg"></i>
</button>
{% endif %}

<!-- Yeni Kayƒ±t Modal -->
<div class="modal fade" id="yeniKayitModal" tabindex="-1" aria-labelledby="yeniKayitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="yeniKayitModalLabel">
                    <i class="bi bi-plus-lg me-2"></i>
                    Yeni √áƒ±kma Lastik Kaydƒ±
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6 col-12">
                            <label for="marka" class="form-label">Marka *</label>
                            <input type="text" class="form-control" id="marka" name="marka" required>
                        </div>
                        <div class="col-md-6 col-12">
                            <label for="model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="model" name="model" placeholder="Lastik modeli">
                        </div>
                        <div class="col-md-6 col-12">
                            <label for="ebat" class="form-label">Ebat *</label>
                            <input type="text" class="form-control" id="ebat" name="ebat" placeholder="205/55R16" required>
                            <small class="text-muted">√ñrnek: 205/55R16 veya 2055516</small>
                        </div>
                        <div class="col-md-6 col-12">
                            <label for="mevsim" class="form-label">Mevsim *</label>
                            <select class="form-select" id="mevsim" name="mevsim" required>
                                <option value="">Se√ßiniz</option>
                                {% for value, label in mevsim_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 col-12">
                            <label for="adet" class="form-label">Adet *</label>
                            <input type="number" class="form-control" id="adet" name="adet" min="1" value="1" required>
                        </div>
                        <div class="col-md-6 col-12">
                            <label for="kalite_notu" class="form-label">Kalite</label>
                            <select class="form-select" id="kalite_notu" name="kalite_notu">
                                <option value="">Se√ßiniz</option>
                                {% for value, label in kalite_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 col-12">
                            <label for="durum" class="form-label">Durum</label>
                            <select class="form-select" id="durum" name="durum">
                                <option value="depolandi" selected>Depolandƒ±</option>
                                <option value="satildi">Satƒ±ldƒ±</option>
                            </select>
                        </div>
                        <div class="col-md-6 col-12">
                            <label for="depo_konumu" class="form-label">Depo Konumu</label>
                            <input type="text" class="form-control" id="depo_konumu" name="depo_konumu" placeholder="Raf A-1, Saha 2 vb.">
                        </div>
                        
                        <!-- Satƒ±≈ü Bilgileri - Sadece durum "satildi" ise g√∂ster -->
                        <div class="col-md-6 col-12" id="satis_fiyati_field_new" style="display: none;">
                            <label for="satis_fiyati_new" class="form-label">Satƒ±≈ü Fiyatƒ± (‚Ç∫)</label>
                            <input type="number" class="form-control" id="satis_fiyati_new" name="satis_fiyati" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 col-12" id="satis_tarihi_field_new" style="display: none;">
                            <label for="satis_tarihi_new" class="form-label">Satƒ±≈ü Tarihi</label>
                            <input type="date" class="form-control" id="satis_tarihi_new" name="satis_tarihi">
                        </div>
                        
                        <div class="col-12">
                            <label for="aciklama" class="form-label">A√ßƒ±klama</label>
                            <textarea class="form-control" id="aciklama" name="aciklama" rows="2" placeholder="Ek notlar, √∂zel durumlar vb."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-1"></i>
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Satƒ±≈ü Modallarƒ± -->
{% for lastik in cikma_lastikler %}
<div class="modal fade" id="satisModal{{ lastik.id }}" tabindex="-1" aria-labelledby="satisModalLabel{{ lastik.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="satisModalLabel{{ lastik.id }}">
                    <i class="bi bi-currency-dollar me-2"></i>
                    √áƒ±kma Lastik Satƒ±≈üƒ±
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'dashboard:cikma_lastik_sat' lastik.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- √úr√ºn Bilgisi -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="card-title mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                √úr√ºn Bilgisi
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <strong>Marka/Model:</strong><br>
                                    <span class="text-primary">{{ lastik.marka }}</span>
                                    {% if lastik.model %}
                                        <br><small class="text-muted">{{ lastik.model }}</small>
                                    {% endif %}
                                </div>
                                <div class="col-6">
                                    <strong>Ebat:</strong><br>
                                    <code class="ebat-code">{{ lastik.ebat }}</code>
                                </div>
                                <div class="col-6 mt-2">
                                    <strong>Mevsim:</strong><br>
                                    {% if lastik.mevsim == 'yaz' %}
                                        <img src="{% static 'images/yaz.png' %}" alt="Yaz" class="mevsim-icon">
                                        Yaz
                                    {% elif lastik.mevsim == 'kis' %}
                                        <img src="{% static 'images/kis.png' %}" alt="Kƒ±≈ü" class="mevsim-icon">
                                        Kƒ±≈ü
                                    {% elif lastik.mevsim == 'dort-mevsim' %}
                                        <img src="{% static 'images/d√∂rtmevsim.png' %}" alt="4 Mevsim" class="mevsim-icon">
                                        4 Mevsim
                                    {% endif %}
                                </div>
                                {% if not is_misafir %}
                                <div class="col-6 mt-2">
                                    <strong>Kalite:</strong><br>
                                    {{ lastik.get_kalite_display }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Satƒ±≈ü Bilgileri -->
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="satis_adet_{{ lastik.id }}" class="form-label">Satƒ±lacak Adet *</label>
                            <input type="number" class="form-control" id="satis_adet_{{ lastik.id }}" name="satis_adet" 
                                   min="1" max="{{ lastik.adet }}" value="{{ lastik.adet }}" required>
                            <small class="text-muted">Mevcut: <strong>{{ lastik.adet }} adet</strong></small>
                        </div>
                        <div class="col-12">
                            <label for="satis_fiyati_{{ lastik.id }}" class="form-label">Satƒ±≈ü Fiyatƒ± (‚Ç∫) *</label>
                            <input type="number" class="form-control" id="satis_fiyati_{{ lastik.id }}" name="satis_fiyati" 
                                   step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="col-12">
                            <label for="satis_tarihi_{{ lastik.id }}" class="form-label">Satƒ±≈ü Tarihi</label>
                            <input type="date" class="form-control" id="satis_tarihi_{{ lastik.id }}" name="satis_tarihi" 
                                   value="{{ 'now'|date:'Y-m-d' }}">
                        </div>
                        <div class="col-12">
                            <label for="satis_aciklama_{{ lastik.id }}" class="form-label">Satƒ±≈ü A√ßƒ±klamasƒ±</label>
                            <textarea class="form-control" id="satis_aciklama_{{ lastik.id }}" name="satis_aciklama" 
                                      rows="2" placeholder="M√º≈üteri bilgisi, √∂deme ≈üekli vb."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒ∞ptal</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg me-1"></i>
                        Satƒ±≈üƒ± Tamamla
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('√áƒ±kma Lastikler sayfasƒ± y√ºklendi');
    
    // Mobil dokunmatik optimizasyonlarƒ±
    if ('ontouchstart' in window) {
        // Touch cihazlarda hover efektlerini devre dƒ±≈üƒ± bƒ±rak
        document.body.classList.add('touch-device');
    }
    
    // Quick filter butonlarƒ±
    document.querySelectorAll('.quick-filter-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            // Loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            this.style.pointerEvents = 'none';
            
            // Restore after navigation
            setTimeout(() => {
                this.innerHTML = originalText;
                this.style.pointerEvents = 'auto';
            }, 1000);
        });
    });
    
    // Yeni kayƒ±t formunda satƒ±≈ü alanlarƒ± kontrol√º
    const durumSelectNew = document.getElementById('durum');
    const satisFiyatiFieldNew = document.getElementById('satis_fiyati_field_new');
    const satisTarihiFieldNew = document.getElementById('satis_tarihi_field_new');
    const satisFiyatiInputNew = document.getElementById('satis_fiyati_new');
    const satisTarihiInputNew = document.getElementById('satis_tarihi_new');
    
    function toggleSatisFieldsNew() {
        if (durumSelectNew && durumSelectNew.value === 'satildi') {
            satisFiyatiFieldNew.style.display = 'block';
            satisTarihiFieldNew.style.display = 'block';
            
            // Satƒ±≈ü tarihi bo≈üsa bug√ºn√ºn tarihini set et
            if (!satisTarihiInputNew.value) {
                const today = new Date().toISOString().split('T')[0];
                satisTarihiInputNew.value = today;
            }
        } else {
            satisFiyatiFieldNew.style.display = 'none';
            satisTarihiFieldNew.style.display = 'none';
            
            // Depolandƒ± durumunda satƒ±≈ü bilgilerini temizle
            satisFiyatiInputNew.value = '';
            satisTarihiInputNew.value = '';
        }
    }
    
    if (durumSelectNew) {
        // Sayfa y√ºklendiƒüinde kontrol et
        toggleSatisFieldsNew();
        
        // Durum deƒüi≈ütiƒüinde kontrol et
        durumSelectNew.addEventListener('change', toggleSatisFieldsNew);
    }
    
    // Mobil kart animasyonlarƒ±
    const lastikCards = document.querySelectorAll('.lastik-card');
    lastikCards.forEach(function(card, index) {
        // Staggered animation
        card.style.animationDelay = (index * 0.1) + 's';
        card.classList.add('fade-in-up');
    });
    
    // Form validation improvements
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Kaydediliyor...';
                
                // Re-enable after 3 seconds (fallback)
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = submitBtn.innerHTML.replace('Kaydediliyor...', 'Kaydet');
                }, 3000);
            }
        });
    });
    
    // Swipe gestures for mobile cards
    if ('ontouchstart' in window) {
        let startX, startY, currentCard;
        
        lastikCards.forEach(function(card) {
            card.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                currentCard = this;
            });
            
            card.addEventListener('touchmove', function(e) {
                if (!startX || !startY) return;
                
                const currentX = e.touches[0].clientX;
                const currentY = e.touches[0].clientY;
                const diffX = startX - currentX;
                const diffY = startY - currentY;
                
                // Horizontal swipe detection
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    e.preventDefault();
                    
                    if (diffX > 0) {
                        // Swipe left - show actions
                        this.style.transform = 'translateX(-20px)';
                        this.style.backgroundColor = '#f8f9fa';
                    } else {
                        // Swipe right - hide actions
                        this.style.transform = 'translateX(0)';
                        this.style.backgroundColor = 'white';
                    }
                }
            });
            
            card.addEventListener('touchend', function() {
                startX = null;
                startY = null;
                
                // Reset transform after a delay
                setTimeout(() => {
                    this.style.transform = 'translateX(0)';
                    this.style.backgroundColor = 'white';
                }, 2000);
            });
        });
    }
    
    // Auto-focus on search inputs in compact filter
    const markaInput = document.querySelector('.compact-mobile-filter input[name="marka"]');
    
    if (markaInput && window.innerWidth <= 768) {
        // Sayfa y√ºklendiƒüinde focus ver
        setTimeout(() => {
            markaInput.focus();
        }, 500);
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + N for new record
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
            e.preventDefault();
            const newRecordBtn = document.querySelector('[data-bs-target="#yeniKayitModal"]');
            if (newRecordBtn) {
                newRecordBtn.click();
            }
        }
        
        // Escape to close modals
        if (e.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal.show');
            openModals.forEach(modal => {
                const bsModal = bootstrap.Modal.getInstance(modal);
                if (bsModal) bsModal.hide();
            });
        }
    });
});

// WhatsApp mesaj g√∂nderme fonksiyonu (mobil optimized)
function whatsappGonder(telefon, musteriAdi, lastikBilgisi) {
    // Telefon numarasƒ±nƒ± temizle ve formatla
    let cleanTelefon = telefon.toString().replace(/\D/g, '');
    
    // T√ºrkiye telefon numarasƒ± formatƒ± kontrol√º
    if (cleanTelefon.startsWith('0')) {
        cleanTelefon = '90' + cleanTelefon.substring(1);
    } else if (!cleanTelefon.startsWith('90')) {
        cleanTelefon = '90' + cleanTelefon;
    }
    
    // Mesaj formatƒ±
    const mesaj = `*MesTakip - √áƒ±kma Lastik*

Sayƒ±n ${musteriAdi},

Aracƒ±nƒ±zdan √ßƒ±kan lastik bilgileri:
*Lastik:* ${lastikBilgisi}

Lastikleriniz g√ºvenli bir ≈üekilde depolanmƒ±≈ütƒ±r.

ƒ∞yi g√ºnler dileriz.`;
    
    console.log('WhatsApp mesajƒ± g√∂nderiliyor:', mesaj);
    
    // WhatsApp URL'si olu≈ütur
    const whatsappUrl = `https://wa.me/${cleanTelefon}?text=${encodeURIComponent(mesaj)}`;
    
    // Mobil cihazlarda aynƒ± sekmede a√ß, desktop'ta yeni sekmede
    if (window.innerWidth <= 768) {
        window.location.href = whatsappUrl;
    } else {
        window.open(whatsappUrl, '_blank');
    }
}

// D√ºzenle ve Sil butonlarƒ± i√ßin event handler'lar
document.addEventListener('DOMContentLoaded', function() {
    // D√ºzenle butonlarƒ±
    document.querySelectorAll('[data-edit-url]').forEach(function(button) {
        button.addEventListener('click', function() {
            // Loading state
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            this.disabled = true;
            
            // Navigate
            window.location.href = this.getAttribute('data-edit-url');
        });
    });
    
    // Sil butonlarƒ±
    document.querySelectorAll('[data-delete-url]').forEach(function(button) {
        button.addEventListener('click', function() {
            const message = this.getAttribute('data-confirm-message');
            
            // Mobil cihazlarda daha b√ºy√ºk confirm dialog
            if (window.innerWidth <= 768) {
                // Custom mobile-friendly confirm
                const result = confirm(message + '\n\nBu i≈ülem geri alƒ±namaz!');
                if (result) {
                    // Loading state
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                    this.disabled = true;
                    
                    window.location.href = this.getAttribute('data-delete-url');
                }
            } else {
                if (confirm(message)) {
                    window.location.href = this.getAttribute('data-delete-url');
                }
            }
        });
    });
    
    // Haptic feedback for mobile (if supported)
    if ('vibrate' in navigator && window.innerWidth <= 768) {
        document.querySelectorAll('.btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.vibrate(50); // Short vibration
            });
        });
    }
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .fade-in-up {
        animation: fadeInUp 0.5s ease-out forwards;
    }
    
    .touch-device .btn:hover {
        transform: none !important;
    }
    
    @media (max-width: 768px) {
        .btn {
            transition: all 0.2s ease;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .lastik-card {
            transition: all 0.3s ease;
        }
        
        .lastik-card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}